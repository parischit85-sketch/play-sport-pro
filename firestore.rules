// =====================================================
// Firestore Security Rules - PRODUCTION READY (CHK-310)
// Updated: 2025-11-12
// Comprehensive security rules with:
// - Authentication required
// - Role-based access control (RBAC)
// - Super admin support
// - Field-level validation
// - Rate limiting hints
// =====================================================

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // HELPER FUNCTIONS
    // ==========================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is the document owner
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user is admin or super admin
    // Primary check: Firebase Auth custom claims (cryptographically signed)
    // Secondary check: Admin email whitelist (fast, reliable fallback)
    // Tertiary check: Admin collection (if all else fails)
    function isAdmin() {
      return isAuthenticated() && (
        request.auth.token.admin == true ||
        request.auth.token.role == 'super_admin' ||
        request.auth.token.role == 'admin' ||
        request.auth.token.admin_email == 'paris.andrea@live.it' ||
        request.auth.email == 'paris.andrea@live.it' ||
        exists(/databases/$(database)/documents/admin/$(request.auth.uid))
      );
    }
    
    // Check if user is club admin for specific club
    // Super admins can manage all clubs
    function isClubAdminForClub(clubId) {
      return isAuthenticated() &&
             (request.auth.token.admin == true ||
              request.auth.token.role == 'super_admin' ||
              (exists(/databases/$(database)/documents/clubs/$(clubId)) &&
               get(/databases/$(database)/documents/clubs/$(clubId)).data.ownerId == request.auth.uid));
    }

    // Check if user is club owner
    function isClubOwner(clubId) {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/clubs/$(clubId)).data.ownerId == request.auth.uid;
    }
    // Validate email format
    function isValidEmail(email) {
      return email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }
    
    // Validate timestamp is not in the past (with 5 min tolerance)
    function isValidFutureTimestamp(ts) {
      return ts > request.time.toMillis() - 300000;
    }
    
    // Check if data size is within limit (prevent abuse)
    function isWithinSizeLimit(maxSize) {
      return request.resource.size() < maxSize;
    }
    
    // ==========================================
    // USERS COLLECTION
    // ==========================================
    match /users/{userId} {
      // Read: User can read own profile, admins can read all
      allow read: if isOwner(userId) || isAdmin();
      
      // Create: Only during sign-up, must match auth uid
      allow create: if isAuthenticated() && 
                       request.auth.uid == userId &&
                       isValidEmail(request.resource.data.email) &&
                       isWithinSizeLimit(10000);
      
      // Update: User can update own profile (except role), admins can update any user
      allow update: if isAdmin() || (isOwner(userId) && 
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'uid']) &&
                       isWithinSizeLimit(10000));
      
      // Delete: Only admins
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // PROFILES COLLECTION (Extended user profiles)
    // ==========================================
    match /profiles/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId) || isAdmin();
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // ADMIN COLLECTION (Super admin access)
    // ==========================================
    match /admin/{adminId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // ==========================================
    // CLUBS COLLECTION
    // ==========================================
    match /clubs/{clubId} {
      // Read: Public (all clubs visible)
      allow read: if true;
      
      // Create: Only admins can create clubs
      allow create: if isAdmin() && isWithinSizeLimit(50000);
      
      // Update: Any authenticated user can update (will tighten later)
      allow update: if isAuthenticated() && isWithinSizeLimit(50000);
      
      // Delete: Only admins
      allow delete: if isAdmin();
      
      // Nested club users
      match /users/{userId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
      
      // Nested club profiles
      match /profiles/{profileId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
      
      // Nested club matches
      match /matches/{matchId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
    }
    
    // ==========================================
    // COURTS COLLECTION
    // ==========================================
    match /courts/{courtId} {
      // Read: Public (all courts visible)
      allow read: if true;

      // Create: Club admin/owner or admin (must specify clubId in document)
      allow create: if (request.resource.data.clubId is string &&
                        (isClubAdminForClub(request.resource.data.clubId) || isAdmin())) &&
                       isWithinSizeLimit(20000);

      // Update: Club admin/owner or admin (validate club ownership)
      allow update: if (isClubAdminForClub(resource.data.clubId) || isAdmin()) &&
                       isWithinSizeLimit(20000);

      // Delete: Only admins
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // AFFILIATIONS COLLECTION
    // ==========================================
    match /affiliations/{affiliationId} {
      // Read: Any authenticated user can read
      allow read: if isAuthenticated();
      
      // Create: Any authenticated user can create
      allow create: if isAuthenticated();
      
      // Update: Any authenticated user can update
      allow update: if isAuthenticated();
      
      // Delete: Any authenticated user can delete
      allow delete: if isAuthenticated();
    }
    
    // ==========================================
    // BOOKINGS COLLECTION
    // ==========================================
    match /bookings/{bookingId} {
      // Read: Admin can read all, user can read own, club admin can read their club's
      allow read: if isAdmin() ||
                     isOwner(resource.data.userId) ||
                     isClubAdminForClub(resource.data.clubId);

      // Create: Authenticated users only, must be own booking, valid timestamp
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       isValidFutureTimestamp(request.resource.data.startTime) &&
                       request.resource.data.status == 'pending' &&
                       isWithinSizeLimit(10000);

      // Update: Owner can update own booking (limited fields), club admin can update status, admin can do anything
      allow update: if isAdmin() ||
                       (isOwner(resource.data.userId) &&
                         request.resource.data.diff(resource.data).affectedKeys().hasAny(['status', 'notes']) == false) ||
                       (isClubAdminForClub(resource.data.clubId) &&
                         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status']));

      // Delete: Owner or admin
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }
    
    // ==========================================
    // PAYMENTS COLLECTION
    // ==========================================
    match /payments/{paymentId} {
      // Read: User can read own payments, admins can read all
      allow read: if isOwner(resource.data.userId) || isAdmin();
      
      // Create: System only (via Cloud Functions)
      allow create: if false;
      
      // Update: Admins only
      allow update: if isAdmin();
      
      // Delete: Never
      allow delete: if false;
    }
    
    // ==========================================
    // LEAGUES COLLECTION
    // ==========================================
    match /leagues/{leagueId} {
      // Read: Public
      allow read: if true;
      
      // Create: Admins only
      allow create: if isAdmin() && 
                       isWithinSizeLimit(50000);
      
      // Update: Admins only
      allow update: if isAdmin() &&
                       isWithinSizeLimit(50000);
      
      // Delete: Admins only
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // TOURNAMENTS COLLECTION
    // ==========================================
    match /tournaments/{tournamentId} {
      // Read: Public
      allow read: if true;

      // Create: Club admin or admin (must specify clubId)
      allow create: if (request.resource.data.clubId is string &&
                        (isClubAdminForClub(request.resource.data.clubId) || isAdmin())) &&
                       isWithinSizeLimit(50000);

      // Update: Club admin or admin (validate club ownership)
      allow update: if (isClubAdminForClub(resource.data.clubId) || isAdmin()) &&
                       isWithinSizeLimit(50000);

      // Delete: Admins only
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // NOTIFICATIONS COLLECTION
    // ==========================================
    match /notifications/{notificationId} {
      // Read: User can read own notifications, admins can read all
      allow read: if isOwner(resource.data.userId) || isAdmin();
      
      // Create: System only (via Cloud Functions)
      allow create: if false;
      
      // Update: User can mark as read, admin can update any
      allow update: if isAdmin() ||
                       (isOwner(resource.data.userId) &&
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt']));
      
      // Delete: User can delete own notifications, admin can delete any
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }
    
    // ==========================================
    // ANALYTICS COLLECTION (Admin only)
    // ==========================================
    match /analytics/{documentId} {
      allow read: if isAdmin();
      allow write: if false; // Written by Cloud Functions only
    }
    
    // ==========================================
    // AUDIT_LOGS COLLECTION (Admin only)
    // ==========================================
    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Written by Cloud Functions only
    }
    
    // ==========================================
    // FEATURE_FLAGS COLLECTION (Admin only)
    // ==========================================
    match /feature_flags/{flagId} {
      allow read: if isAuthenticated(); // All users can read flags
      allow write: if isAdmin(); // Only admins can modify
    }
    
    // ==========================================
    // EXPERIMENTS COLLECTION (Admin only)
    // ==========================================
    match /experiments/{experimentId} {
      allow read: if isAuthenticated(); // All users can read experiments
      allow write: if isAdmin(); // Only admins can modify
    }
    
    // ==========================================
    // PUSH SUBSCRIPTIONS COLLECTION
    // ==========================================
    match /pushSubscriptions/{subscriptionId} {
      // Read: Only Cloud Functions and authenticated user can read own
      // For performance: this is mostly written by Netlify Functions, 
      // but we allow Cloud Functions to query for sending notifications
      allow read: if false; // Cloud Functions use admin SDK (bypass rules)
      
      // Create: Netlify Functions only (via service auth)
      // Since Netlify Functions are external, we use admin SDK which bypasses rules
      allow create: if false;
      
      // Update: Netlify Functions only
      allow update: if false;
      
      // Delete: Cloud Functions for TTL cleanup
      allow delete: if false;
    }
    
    
    // ==========================================
    // DENY ALL OTHER COLLECTIONS
    // ==========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
