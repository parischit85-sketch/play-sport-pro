<!DOCTYPE html>
<html>
<head>
    <title>Test Push Subscription</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e293b;
            color: #e2e8f0;
        }
        button {
            padding: 12px 24px;
            margin: 10px 5px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #059669;
        }
        .log {
            background: #0f172a;
            border: 1px solid #334155;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            padding: 5px;
            margin: 5px 0;
            border-bottom: 1px solid #1e293b;
        }
        .success { color: #34d399; }
        .error { color: #f87171; }
        .info { color: #60a5fa; }
    </style>
</head>
<body>
    <h1>üß™ Test Push Subscription Direct</h1>
    <p>Test diretto per verificare il salvataggio delle push subscription</p>
    
    <div>
        <button onclick="testSubscription()">üîî Test Subscription Save</button>
        <button onclick="checkFirestore()">üîç Check Firestore</button>
        <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
    </div>

    <div id="log" class="log"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase config (usa la stessa configurazione della tua app)
        const firebaseConfig = {
            apiKey: "AIzaSyDMP7772cyEY1oLzo8f9hMW7Leu4lWc6OU",
            authDomain: "m-padelweb.firebaseapp.com",
            projectId: "m-padelweb",
            storageBucket: "m-padelweb.firebasestorage.app",
            messagingSenderId: "746063883926",
            appId: "1:746063883926:web:43db23a75fb1fc2dde8c20",
            measurementId: "G-KL18PBGQ45"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                log(`‚úÖ Logged in as: ${user.email} (${user.uid})`, 'success');
            } else {
                log('‚ùå Not logged in. Please login first.', 'error');
            }
        });

        window.log = function(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.insertBefore(entry, logDiv.firstChild);
            console.log(message);
        };

        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
        };

        window.testSubscription = async function() {
            if (!currentUser) {
                log('‚ùå User not authenticated', 'error');
                return;
            }

            log('üîî Starting subscription test...', 'info');

            try {
                // 1. Request permission
                log('üìù Requesting notification permission...', 'info');
                const permission = await Notification.requestPermission();
                log(`‚úÖ Permission: ${permission}`, permission === 'granted' ? 'success' : 'error');

                if (permission !== 'granted') {
                    log('‚ùå Permission denied. Cannot continue.', 'error');
                    return;
                }

                // 2. Register service worker
                log('üìù Registering service worker...', 'info');
                const registration = await navigator.serviceWorker.register('/sw.js');
                await navigator.serviceWorker.ready;
                log('‚úÖ Service worker registered', 'success');

                // 3. Subscribe to push
                log('üìù Creating push subscription...', 'info');
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: 'BEPdDLzmIjBd2fTRR42nMJ5DnqtYM9dB8SPqH-dHIYJZfZQQ6CbTBWdYGBJOBkBhCHMzPRLGKLR8mfphzELDQHM'
                });
                log('‚úÖ Push subscription created', 'success');
                log(`üìä Endpoint: ${subscription.endpoint.substring(0, 80)}...`, 'info');

                // 4. Save to Firestore directly (no Netlify Function in dev)
                log('üìù Saving subscription to Firestore...', 'info');
                const subscriptionData = {
                    userId: currentUser.uid,
                    type: 'web', // Importante: web push subscription
                    endpoint: subscription.endpoint,
                    keys: {
                        p256dh: btoa(String.fromCharCode(...new Uint8Array(subscription.getKey('p256dh')))),
                        auth: btoa(String.fromCharCode(...new Uint8Array(subscription.getKey('auth'))))
                    },
                    deviceId: 'test-device-' + Date.now(),
                    createdAt: new Date().toISOString(),
                    expirationTime: subscription.expirationTime,
                    isActive: true,
                    expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString()
                };

                const { setDoc, doc, collection } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const docRef = doc(collection(db, 'pushSubscriptions'));
                await setDoc(docRef, subscriptionData);

                log(`‚úÖ Subscription saved to Firestore! ID: ${docRef.id}`, 'success');
                log('üéâ TEST COMPLETED SUCCESSFULLY!', 'success');
                log('üëâ Now click "Check Firestore" to verify', 'info');

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        };

        window.checkFirestore = async function() {
            if (!currentUser) {
                log('‚ùå User not authenticated', 'error');
                return;
            }

            log('üîç Checking Firestore for subscriptions...', 'info');

            try {
                const q = query(
                    collection(db, 'pushSubscriptions'),
                    where('userId', '==', currentUser.uid),
                    orderBy('createdAt', 'desc')
                );

                const querySnapshot = await getDocs(q);
                log(`üìä Found ${querySnapshot.size} subscription(s)`, 'info');

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    log(`üìÑ ID: ${doc.id}`, 'info');
                    log(`   - Created: ${data.createdAt}`, 'info');
                    log(`   - Active: ${data.isActive}`, 'info');
                    log(`   - Expires: ${data.expiresAt}`, 'info');
                    log(`   - Endpoint: ${data.endpoint?.substring(0, 60)}...`, 'info');
                });

            } catch (error) {
                log(`‚ùå Error checking Firestore: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        };
    </script>
</body>
</html>
